<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mirus Stats Lab</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121a2f; --muted:#93a3c7; --text:#eef4ff; --acc:#22c55e; --line:#263350;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter, system-ui, Arial; background:linear-gradient(180deg,#0a0f1d,#0e1730); color:var(--text);}
    .app{max-width:1200px; margin:0 auto; padding:18px; display:grid; grid-template-columns:300px 1fr; gap:14px; min-height:100vh;}
    @media(max-width:980px){.app{grid-template-columns:1fr;}}
    .panel{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:14px;}
    h1{margin:0 0 6px; font-size:18px}
    p{margin:0; color:var(--muted)}
    .controls{display:grid; gap:10px; margin-top:12px;}
    label{font-size:12px; color:#c8d7f7; display:grid; gap:6px;}
    input, select, button{border-radius:10px; border:1px solid #33466e; background:#0d1529; color:var(--text); padding:9px 10px;}
    button{cursor:pointer; background:#16356f; border-color:#3c69b5; font-weight:700}
    button:disabled{opacity:.6; cursor:not-allowed}
    .kpi{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:10px; margin-bottom:12px;}
    @media(max-width:980px){.kpi{grid-template-columns:repeat(2,minmax(0,1fr));}}
    .card{background:#0d1528; border:1px solid var(--line); border-radius:12px; padding:10px;}
    .card .k{font-size:12px; color:var(--muted)}
    .card .v{font-size:24px; font-weight:800; margin-top:3px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media(max-width:980px){.grid{grid-template-columns:1fr;}}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{padding:7px 8px; border-bottom:1px solid var(--line); text-align:left}
    th{color:#c4d3f5; font-size:12px; text-transform:uppercase; letter-spacing:.5px}
    .hist{display:grid; gap:6px}
    .bar{display:grid; grid-template-columns:66px 1fr 50px; gap:8px; align-items:center; font-size:12px;}
    .track{height:10px; border-radius:999px; background:#0a1222; border:1px solid #29395a; overflow:hidden}
    .fill{height:100%; background:linear-gradient(90deg,#2dd4bf,#60a5fa)}
    .small{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel">
      <h1>Mirus Stats Lab</h1>
      <p>Batch simulation basata sul core di <code>index.html</code>.</p>
      <div class="controls">
        <label>Numero partite
          <input id="games" type="number" min="1" max="20000" value="1000" />
        </label>
        <label>Strategia Player
          <select id="playerStrategy">
            <option value="random">Random</option>
            <option value="greedy">Greedy</option>
            <option value="mc" selected>Monte Carlo</option>
          </select>
        </label>
        <label>Strategia AI
          <select id="aiStrategy">
            <option value="random">Random</option>
            <option value="greedy">Greedy</option>
            <option value="mc" selected>Monte Carlo</option>
          </select>
        </label>
        <label>Parte per primo
          <select id="startMode">
            <option value="human">Player</option>
            <option value="ai">AI</option>
            <option value="alternate" selected>Alternato</option>
          </select>
        </label>
        <button id="runBtn">Esegui simulazione</button>
        <div id="status" class="small">Pronto.</div>
      </div>
    </aside>

    <main class="panel">
      <div class="kpi">
        <div class="card"><div class="k">Partite</div><div class="v" id="kGames">0</div></div>
        <div class="card"><div class="k">Win rate Player</div><div class="v" id="kPlayerWin">0%</div></div>
        <div class="card"><div class="k">Win rate AI</div><div class="v" id="kAIWin">0%</div></div>
        <div class="card"><div class="k">Pareggi</div><div class="v" id="kDraw">0%</div></div>
      </div>

      <div class="grid">
        <section class="card">
          <h3>Score summary</h3>
          <table>
            <thead><tr><th>Metric</th><th>Player</th><th>AI</th></tr></thead>
            <tbody id="scoreTable"></tbody>
          </table>
        </section>
        <section class="card">
          <h3>Distribuzione margine (AI - Player)</h3>
          <div id="marginHist" class="hist"></div>
        </section>
      </div>

      <div class="grid" style="margin-top:10px;">
        <section class="card">
          <h3>Frequenza eventi</h3>
          <table>
            <thead><tr><th>Evento</th><th>Media per partita</th></tr></thead>
            <tbody id="eventTable"></tbody>
          </table>
        </section>
        <section class="card">
          <h3>Breakdown VP medio</h3>
          <table>
            <thead><tr><th>Categoria</th><th>Player</th><th>AI</th></tr></thead>
            <tbody id="vpTable"></tbody>
          </table>
        </section>
      </div>
    </main>
  </div>

  <iframe id="coreFrame" src="index.html" style="display:none"></iframe>

<script>
(function(){
  const frame = document.getElementById("coreFrame");
  const runBtn = document.getElementById("runBtn");
  const statusEl = document.getElementById("status");

  const els = {
    kGames: document.getElementById("kGames"),
    kPlayerWin: document.getElementById("kPlayerWin"),
    kAIWin: document.getElementById("kAIWin"),
    kDraw: document.getElementById("kDraw"),
    scoreTable: document.getElementById("scoreTable"),
    marginHist: document.getElementById("marginHist"),
    eventTable: document.getElementById("eventTable"),
    vpTable: document.getElementById("vpTable")
  };

  let Core = null;

  function avg(arr){ return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }
  function pct(x, n){ return n ? (100*x/n).toFixed(1) + "%" : "0.0%"; }

  function quantile(sorted, q){
    if (!sorted.length) return 0;
    const p = (sorted.length - 1) * q;
    const lo = Math.floor(p), hi = Math.ceil(p);
    if (lo === hi) return sorted[lo];
    return sorted[lo] + (sorted[hi] - sorted[lo]) * (p - lo);
  }

  function chooseForPlayer(state, player, level){
    if (typeof Core.chooseMoveForPlayer === "function"){
      return Core.chooseMoveForPlayer(state, player, {level});
    }

    const pv = Core.Engine.getPublicView(state);
    const moves = Core.enumerateMoves(pv, player);
    return moves.length ? moves[0] : null;
  }

  function applyMove(state, player, mv){
    if (!mv) return;
    if (mv.type === "kingFinal") { Core.Engine.chooseKingWonder(state, {cardId: mv.cardId, delta: mv.delta}, true); return; }
    if (mv.type === "modernSwap") { Core.Engine.useModernSwap(state, player); return; }
    if (mv.type === "wonder") { Core.Engine.useJokerDouble(state); return; }
    if (mv.type === "take") { Core.Engine.take(state, mv.idx); return; }
    if (mv.type === "pass") { state.pub.picksLeftThisTurn = 1; state.pub.currentPlayer = 1 - state.pub.currentPlayer; }
  }

  function playout(state, p0Level, p1Level){
    let guard = 0;
    while(!state.pub.ended && guard < 600){
      guard++;
      const p = state.pub.currentPlayer;
      const level = p===0 ? p0Level : p1Level;
      const mv = chooseForPlayer(state, p, level);
      applyMove(state, p, mv);
    }
  }

  function simulateOne(startingPlayer, p0Level, p1Level){
    const state = Core.Engine.newGame(startingPlayer);
    const events = {playerWonder:0, aiWonder:0, playerSwap:0, aiSwap:0, kingChoices:0};

    let guard = 0;
    while(!state.pub.ended && guard < 600){
      guard++;
      const p = state.pub.currentPlayer;
      const level = p===0 ? p0Level : p1Level;
      const mv = chooseForPlayer(state, p, level);
      if (mv?.type === "wonder") p===0 ? events.playerWonder++ : events.aiWonder++;
      if (mv?.type === "modernSwap") p===0 ? events.playerSwap++ : events.aiSwap++;
      if (mv?.type === "kingFinal") events.kingChoices++;
      applyMove(state, p, mv);
    }

    const final = state.pub.score;
    const breakdown = Core.totalScoring(state.pub.taken[0], state.pub.taken[1], state.pub.wonderMark || null);
    return {
      player: final.human,
      ai: final.ai,
      margin: final.ai - final.human,
      winner: final.human === final.ai ? "draw" : (final.human > final.ai ? "player" : "ai"),
      events,
      anc: breakdown.detail.anc,
      mod: breakdown.detail.mod
    };
  }

  function renderRows(tbody, rows){
    tbody.innerHTML = rows.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td>${r[2]!==undefined?`<td>${r[2]}</td>`:""}</tr>`).join("");
  }

  function renderHistogram(margins){
    const buckets = new Map();
    for (let x=-20; x<=20; x+=4) buckets.set(`${x}..${x+3}`, 0);
    buckets.set("<=-21",0); buckets.set(">=21",0);

    for (const m of margins){
      if (m <= -21) buckets.set("<=-21", buckets.get("<=-21")+1);
      else if (m >= 21) buckets.set(">=21", buckets.get(">=21")+1);
      else {
        const b = Math.floor((m + 20) / 4);
        const s = -20 + b*4;
        const key = `${s}..${s+3}`;
        buckets.set(key, buckets.get(key)+1);
      }
    }

    const total = margins.length || 1;
    const maxN = Math.max(...buckets.values(), 1);
    els.marginHist.innerHTML = [...buckets.entries()].map(([k,v])=>{
      const w = Math.round((v/maxN)*100);
      return `<div class="bar"><div>${k}</div><div class="track"><div class="fill" style="width:${w}%"></div></div><div>${(100*v/total).toFixed(1)}%</div></div>`;
    }).join("");
  }

  async function runBatch(){
    if (!Core){ statusEl.textContent = "Core non ancora disponibile."; return; }
    const n = Math.max(1, Math.min(20000, Number(document.getElementById("games").value) || 1000));
    const p0 = document.getElementById("playerStrategy").value;
    const p1 = document.getElementById("aiStrategy").value;
    const startMode = document.getElementById("startMode").value;

    runBtn.disabled = true;
    statusEl.textContent = `Simulazione in corso: 0/${n}`;

    const out = [];
    for (let i=0;i<n;i++){
      const starter = startMode === "alternate" ? (i % 2 === 0 ? "human" : "ai") : startMode;
      out.push(simulateOne(starter, p0, p1));
      statusEl.textContent = `Simulazione in corso: ${i+1}/${n}`;
      await new Promise(r=>setTimeout(r, 0));
    }

    const playerWins = out.filter(x=>x.winner==="player").length;
    const aiWins = out.filter(x=>x.winner==="ai").length;
    const draws = out.length - playerWins - aiWins;

    const pScores = out.map(x=>x.player).sort((a,b)=>a-b);
    const aScores = out.map(x=>x.ai).sort((a,b)=>a-b);
    const margins = out.map(x=>x.margin).sort((a,b)=>a-b);

    const eventTotals = out.reduce((acc,g)=>{
      for (const k of Object.keys(g.events)) acc[k] = (acc[k] || 0) + g.events[k];
      return acc;
    }, {});

    const ancH = avg(out.map(x=>x.anc.human));
    const ancA = avg(out.map(x=>x.anc.ai));
    const modH = avg(out.map(x=>x.mod.human));
    const modA = avg(out.map(x=>x.mod.ai));

    els.kGames.textContent = String(out.length);
    els.kPlayerWin.textContent = pct(playerWins, out.length);
    els.kAIWin.textContent = pct(aiWins, out.length);
    els.kDraw.textContent = pct(draws, out.length);

    renderRows(els.scoreTable, [
      ["Media", avg(pScores).toFixed(2), avg(aScores).toFixed(2)],
      ["Mediana", quantile(pScores, 0.5).toFixed(2), quantile(aScores, 0.5).toFixed(2)],
      ["P5", quantile(pScores, 0.05).toFixed(2), quantile(aScores, 0.05).toFixed(2)],
      ["P95", quantile(pScores, 0.95).toFixed(2), quantile(aScores, 0.95).toFixed(2)],
      ["Media margine (AI-Player)", avg(margins).toFixed(2), "â€”"]
    ]);

    renderRows(els.eventTable, [
      ["Leader Player", (eventTotals.playerWonder / out.length).toFixed(3)],
      ["Leader AI", (eventTotals.aiWonder / out.length).toFixed(3)],
      ["Swap Modern Player", (eventTotals.playerSwap / out.length).toFixed(3)],
      ["Swap Modern AI", (eventTotals.aiSwap / out.length).toFixed(3)],
      ["King final choice", (eventTotals.kingChoices / out.length).toFixed(3)]
    ]);

    renderRows(els.vpTable, [
      ["Ancient VP medi", ancH.toFixed(2), ancA.toFixed(2)],
      ["Modern VP medi", modH.toFixed(2), modA.toFixed(2)],
      ["Totale medio", (ancH+modH).toFixed(2), (ancA+modA).toFixed(2)]
    ]);

    renderHistogram(margins);

    statusEl.textContent = `Completato: ${n} partite.`;
    runBtn.disabled = false;
  }

  runBtn.addEventListener("click", runBatch);

  frame.addEventListener("load", ()=>{
    Core = frame.contentWindow && frame.contentWindow.MirusCore;
    if (!Core){
      statusEl.textContent = "Impossibile caricare il core da index.html.";
      runBtn.disabled = true;
      return;
    }
    statusEl.textContent = "Core caricato da index.html. Pronto.";
  });
})();
</script>
</body>
</html>
